# .github/workflows/validate-ptag-core.yml
name: Validate PTag (core reusable)

# CI PHASES A-B-C-D:
# - Assemble: Install dependencies, verify environment setup
# - Baseline: Core validation (types exist, lint passes, tests pass)
# - Coverage: Generate coverage / testing reports
# - Deploy: Build package and docs (sanity checks for release readiness)

on:
  workflow_call:

permissions:
  contents: read

jobs:
  validate-ptag-core:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: A1) Checkout
        uses: actions/checkout@v6

      - name: A2) Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "24"

      - name: A3) Install ajv-cli
        run: npm install -g ajv-cli

      - name: B1) Validate provenance/ptag.json against core schema
        shell: bash
        run: |
          PTAG_PATH="provenance/ptag.json"
          SCHEMA_URL="https://raw.githubusercontent.com/civic-interconnect/civic-ptag-core-schema/main/schema/ptag.core.schema.json"
          SCHEMA_RAW="ptag.core.schema.raw.json"
          SCHEMA_PATH="ptag.core.schema.runtime.json"

          if [ ! -f "$PTAG_PATH" ]; then
            echo "No $PTAG_PATH found. Skipping P-Tag validation."
            exit 0
          fi

          echo "Using schema: $SCHEMA_URL"
          curl -sSL "$SCHEMA_URL" -o "$SCHEMA_RAW"

          echo "Stripping \$schema meta-schema reference from downloaded schema with jq..."
          jq 'del(.["$schema"])' "$SCHEMA_RAW" > "$SCHEMA_PATH"

          echo "Schema files in workspace:"
          ls -l ptag.core.schema*

          echo "Validating $PTAG_PATH against runtime schema..."
          npx ajv-cli validate \
            --spec=draft2020 \
            -s "$SCHEMA_PATH" \
            -d "$PTAG_PATH" \
            --errors=text
